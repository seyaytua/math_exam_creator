# Math Exam Creator

数学のテスト問題を効率的に作成・管理・出力するためのデスクトップアプリケーション

## バージョン

**v1.4.0**

## 特徴

- ✅ **マークダウンエディタ**: リアルタイムプレビュー付き
- ✅ **数式サポート**: MathJax による LaTeX 数式レンダリング
- ✅ **HTMLエディタ**: 直接HTML編集も可能
- ✅ **表紙作成**: 試験情報の入力と管理
- ✅ **配点設定**: 各問題に配点を設定
- ✅ **必答・選択**: 問題タイプの区別
- ✅ **解答用紙自動生成**: 空欄（ア、イ、ウ等）を自動検出
- ✅ **PDF出力**: HTML/PDF形式でエクスポート
- ✅ **画像挿入**: Base64埋め込みで外部ファイル不要
- ✅ **問題並び替え**: ドラッグ&ドロップで順序変更
- ✅ **プロンプト生成**: AI用プロンプトの自動作成
- ✅ **外部スクリプト実行**: Pythonスクリプトをアプリ内から実行（最大3つ登録可能）
- ✅ **数式エディタ**: ビジュアルLaTeXエディタで数式を簡単作成
- ✅ **UNDO/REDO**: 元に戻す/やり直し機能 (Ctrl+Z / Ctrl+Y)
- ✅ **印刷設定**: 詳細な印刷設定ダイアログ

## 対応環境

### サポートOS

- ✅ **macOS** (10.15 Catalina 以降)
- ✅ **Windows** (Windows 10/11)
- ✅ **Linux** (Ubuntu 20.04 以降)

### プラットフォーム互換性

このアプリケーションは以下の互換性対策を実装しています：

- **改行コード**: すべてのプラットフォームで LF (`\n`) に統一
- **文字エンコーディング**: UTF-8 で統一（Windows の BOM も自動処理）
- **パス区切り**: `Path` クラスで自動変換
- **ファイル保存**: プラットフォームに依存しない安全な保存

## インストール

### 1. 必要な環境

- Python 3.11 以上
- pip (パッケージ管理ツール)

### 2. 依存パッケージのインストール

```bash
# リポジトリをクローン
git clone https://github.com/seyaytua/math_exam_creator.git
cd math_exam_creator

# 仮想環境の作成（推奨）
python -m venv venv

# 仮想環境の有効化
# macOS/Linux:
source venv/bin/activate
# Windows:
venv\Scripts\activate

# 依存パッケージをインストール
pip install -r requirements.txt
```

### 3. PDF出力機能

PDF出力を使用するには、WeasyPrintをインストールします。

**注意**: ビルド済み実行ファイルにはWeasyPrintが含まれています。開発モードで実行する場合のみ、以下の手順でインストールしてください。

#### WeasyPrint のインストール（開発モード用）

```bash
# macOS
brew install cairo pango gdk-pixbuf libffi
pip install weasyprint

# Windows
# GTK+ Runtime for Windows が必要
# https://github.com/tschoonj/GTK-for-Windows-Runtime-Environment-Installer/releases
# インストール後:
pip install weasyprint

# Linux (Ubuntu/Debian)
sudo apt-get install libcairo2 libpango-1.0-0 libpangocairo-1.0-0 libgdk-pixbuf2.0-0 libffi-dev
pip install weasyprint
```

#### ビルド時のWeasyPrint含有

このアプリケーションをPyInstallerでビルドする際、WeasyPrintとその依存ライブラリは自動的に実行ファイルに含まれます。

**macOS**: 
- Homebrewでインストールされたcairoライブラリが自動的に検出され、バンドルされます
- 事前に `brew install cairo pango` を実行してください

**Windows**:
- GTK+ Runtime for Windows が必要です
- ビルド前にシステムにインストールしてください

**Linux**:
- システムのcairoライブラリが使用されます
- ビルド前に必要なライブラリをインストールしてください

## 使い方

### アプリケーションの起動

#### 開発モード（ソースコードから実行）

```bash
python main.py
```

#### 実行ファイル版

**ダウンロード**

[GitHubリリースページ](https://github.com/seyaytua/math_exam_creator/releases)から、お使いのOSに合わせたファイルをダウンロード：

- **macOS**: `Math-Exam-Creator-macOS.zip`
- **Windows**: `Math-Exam-Creator-Windows.zip`

**macOS**
1. ZIPファイルを解凍
2. `Math Exam Creator.app` をアプリケーションフォルダにドラッグ
3. ダブルクリックで起動

**Windows**
1. ZIPファイルを解凍
2. `MathExamCreator.exe` をダブルクリックで起動

**ビルド方法**

実行ファイルを自分でビルドする場合は、[BUILD.md](BUILD.md)を参照してください。

### 基本的な操作

1. **新規プロジェクト作成**: `ファイル` → `新規プロジェクト`
2. **表紙の編集**: 「表紙」タブで試験情報を入力
3. **問題作成**: `挿入` → `新しい問題` で問題を追加
4. **数式入力**: 
   - インライン数式: `$x^2 + 1$`
   - ディスプレイ数式: `$$\int_0^1 x dx$$`
   - **数式エディタ**: `挿入` → `数式エディタ` でビジュアル編集
5. **画像挿入**: ツールバーの「画像を挿入」ボタン
6. **UNDO/REDO**: `Ctrl+Z` で元に戻す、`Ctrl+Y` でやり直し
7. **印刷設定**: `ファイル` → `印刷設定` で用紙サイズや余白を設定
8. **エクスポート**: `ファイル` → `エクスポート` (HTML/PDF選択)

### 数式の記述

#### インライン数式（文中）

```markdown
方程式 $x^2 + 2x + 1 = 0$ を解け。
```

#### ディスプレイ数式（独立）

```markdown
次の積分を計算せよ。

$$
\int_0^1 x^2 \, dx = \frac{1}{3}
$$
```

#### よく使うLaTeX記法

```latex
分数:     $\frac{1}{2}$
根号:     $\sqrt{x}$
積分:     $\int_a^b f(x) dx$
総和:     $\sum_{i=1}^n i$
極限:     $\lim_{x \to 0} f(x)$
上付き:   $x^2$
下付き:   $x_i$
ギリシャ文字: $\alpha$, $\beta$, $\theta$
```

### 数式エディタの使い方

数式エディタを使用すると、LaTeX記法を知らなくても視覚的に数式を作成できます。

#### 起動方法

1. 問題タブを選択
2. `挿入` → `数式エディタ` をクリック
3. 数式エディタダイアログが開きます

#### 機能

数式エディタには5つのタブがあります：

1. **基本**: 分数、上付き・下付き、平方根、括弧、行列
   - 例: `\frac{1}{2}`, `x^2`, `\sqrt{x}`, `\begin{pmatrix}...\end{pmatrix}`

2. **演算子**: 積分、総和、極限、微分、積
   - 例: `\int`, `\sum`, `\lim`, `\frac{d}{dx}`, `\prod`

3. **ギリシャ文字**: 小文字（α, β, γ...）と大文字（Γ, Δ, Θ...）
   - よく使う文字をワンクリックで挿入

4. **関数**: 三角関数、対数、指数関数
   - 例: `\sin`, `\cos`, `\log`, `\ln`, `\exp`

5. **その他**: 矢印、特殊記号、集合記号
   - 例: `\rightarrow`, `\infty`, `\partial`, `\mathbb{R}`, `\mathbb{C}`

#### 使い方の流れ

1. **モード選択**: インライン数式（$...$）またはディスプレイ数式（$$...$$）を選択
2. **記号挿入**: 各タブから必要な記号をクリックして挿入
3. **LaTeX編集**: 必要に応じて、LaTeXコードを直接編集
4. **プレビュー確認**: リアルタイムで数式のプレビューを確認
5. **挿入**: 「挿入」ボタンをクリックして問題エディタに挿入

#### 例: 二次方程式の解の公式

1. 数式エディタを開く
2. 「基本」タブから「分数」を選択 → `\frac{}{}`
3. 分子に `-b \pm \sqrt{}` と入力
4. 「基本」タブから「平方根」内に `b^2 - 4ac` を入力
5. 分母に `2a` と入力
6. プレビューで確認: $$x = \frac{-b \pm \sqrt{b^2 - 4ac}}{2a}$$
7. 「挿入」ボタンで問題に挿入

### 画像の配置オプション

- **左寄せ**: 画像を左に配置
- **中央揃え**: 画像を中央に配置（デフォルト）
- **右寄せ**: 画像を右に配置
- **テキスト回り込み（左）**: 画像を左に配置し、テキストが回り込む
- **テキスト回り込み（右）**: 画像を右に配置し、テキストが回り込む
- **インライン**: 文中に画像を配置

### UNDO/REDO機能

編集作業を元に戻したり、やり直したりできます。

#### ショートカットキー

- **Ctrl+Z**: 元に戻す
- **Ctrl+Y** (Windows/Linux) または **Ctrl+Shift+Z** (macOS): やり直す

#### ツールバー

ツールバーの「↶ 元に戻す」「↷ やり直し」ボタンをクリックしても実行できます。

#### 対応エディタ

- **問題エディタ**: マークダウンテキストのUNDO/REDO
- **表紙エディタ**: 各入力フィールドごとのUNDO/REDO

### 印刷設定

プロジェクトを印刷する前に、詳細な設定を行えます。

#### 印刷設定を開く

`ファイル` → `印刷設定` を選択

#### 設定項目

**用紙設定**
- 用紙サイズ: A4、A3、B4、B5、Letter、Legal
- 向き: 縦、横

**余白設定（mm単位）**
- 上、下、左、右の余白を個別に設定
- デフォルト: 上下15mm、左右20mm

**印刷オプション**
- ✅ 表紙を印刷
- ✅ 問題を印刷
- ☐ 解答用紙を印刷
- ✅ ページ番号を印刷

**印刷部数**
- 1〜100部まで設定可能

#### 印刷の実行

1. 印刷設定ダイアログで設定を確認
2. 「プレビュー」ボタンでプレビュー確認（今後実装予定）
3. 「印刷」ボタンで印刷ダイアログを表示
4. プリンターを選択して印刷

**注意**: 現在の印刷機能は基本実装です。より高度な印刷を行うには、`ファイル` → `エクスポート` でPDFを出力してから印刷することをお勧めします。

### 外部Pythonスクリプトの実行

アプリケーション内から外部のPythonスクリプトを実行できます。

#### 設定方法

1. `ツール` → `外部スクリプト設定` を開く
2. 最大3つのスクリプトを登録可能
3. 各スクリプトには以下を設定：
   - **スクリプト名**: メニューに表示される名前
   - **説明**: スクリプトの用途（オプション）
   - **Python実行環境**: 使用するPythonインタープリタのパス
     - 「現在のPythonを使用」ボタンで自動入力
     - 「自動検出...」ボタンでシステム内のPythonを検索・選択
   - **スクリプトファイル**: 実行する.pyファイルのパス

#### 実行方法

**方法1: ツールバーから実行（推奨）**
1. ツールバーの「▶ スクリプト」ボタンをクリック
2. ドロップダウンメニューから実行したいスクリプトを選択
3. 実行確認ダイアログで「はい」をクリック
4. 実行結果（標準出力、エラー出力、終了コード）が別ウィンドウで表示される

**方法2: メニューから実行**
1. `ツール` メニューから登録したスクリプト名を選択（▶ アイコン付き）
2. 実行確認ダイアログで「はい」をクリック
3. 実行結果が表示される

**特徴**
- ✅ **ターミナルウィンドウを表示しない**: スクリプトはバックグラウンドで実行され、別のターミナルが開かない
- ✅ **結果を専用ウィンドウで表示**: 出力は整理されたダイアログで確認可能
- ✅ **ツールバーから素早くアクセス**: 頻繁に使うスクリプトをワンクリックで実行

#### 使用例

```python
# test_script.py - 数式生成スクリプト例
import sys

def main():
    print("二次方程式の解の公式:")
    print(r"$$x = \frac{-b \pm \sqrt{b^2 - 4ac}}{2a}$$")
    return 0

if __name__ == "__main__":
    sys.exit(main())
```

このスクリプトを実行すると、LaTeX数式が出力され、それをコピーして問題エディタに貼り付けることができます。

#### Pythonインタープリタの検出

macOSでHomebrewを使用している場合、Pythonは以下のようなパスにインストールされている可能性があります：

```
/opt/homebrew/Cellar/python@3.11/3.11.14/Frameworks/Python.framework/Versions/3.11/bin/python3.11
```

「自動検出...」ボタンを使用すると、システム内の以下の場所からPythonを自動的に検索します：
- Homebrew Python (`/opt/homebrew/`, `/usr/local/`)
- システムPython (`/usr/bin/`, `/Library/Frameworks/`)
- ユーザーインストール (Windows: `%LOCALAPPDATA%\Programs\Python`)

#### 注意事項

- **タイムアウトなし**: スクリプトは完了するまで実行されます（v1.2.0から）
- スクリプトのカレントディレクトリは、スクリプトファイルの親ディレクトリになります
- 実行結果は「標準出力」「エラー出力」「すべての出力」の3つのタブで確認できます
- **ターミナルウィンドウは開きません**: スクリプトはバックグラウンドで静かに実行されます
- 登録した3つすべてのスクリプトがツールバーとメニューに表示されます
- macOS/Windows/Linuxすべてで、GUIから直接実行されます

## トラブルシューティング

### Windows で日本語が文字化けする

アプリケーションはUTF-8で統一されているため、通常は問題ありません。
もし文字化けが発生した場合：

1. Pythonの環境変数を確認:
   ```cmd
   set PYTHONIOENCODING=utf-8
   ```

2. システムロケールをUTF-8に設定（Windows 11）

### 数式が表示されない

1. インターネット接続を確認（MathJax は CDN 経由）
2. 数式の記法を確認（`$` または `$$` で囲む）
3. ブラウザで開いてJavaScriptが有効か確認

### PDF出力でエラーが出る

1. weasyprint または xhtml2pdf がインストールされているか確認
   ```bash
   pip list | grep weasyprint
   pip list | grep xhtml2pdf
   ```

2. Windows の場合、GTK+ が正しくインストールされているか確認

## ファイル形式

### プロジェクトファイル (.mep)

JSON形式で保存されます：

```json
{
  "version": "1.0",
  "title": "第1回定期考査",
  "cover_content": "{...}",
  "problems": [...]
}
```

### 設定ファイル

場所: `~/.math_exam_creator/config.json`

## 開発

### 開発環境のセットアップ

```bash
# 開発用パッケージのインストール
pip install pytest black flake8 mypy

# コードフォーマット
black src/

# 型チェック
mypy src/

# テスト実行
pytest tests/
```

## ライセンス

MIT License

## サポート

問題や質問がある場合は、GitHub Issues をご利用ください。

## 変更履歴

### v1.4.0 (2025-11-23)

- UNDO/REDO機能を実装（Ctrl+Z / Ctrl+Y）
- 印刷設定ダイアログを実装（用紙サイズ、余白、オプション）
- 編集メニューに切り取り/コピー/貼り付け機能を追加
- ツールバーにUNDO/REDOボタンを追加
- タブ切り替え時にUNDO/REDO状態を自動更新

### v1.3.0 (2025-11-22)

- 数式エディタを実装（ビジュアルLaTeXエディタ）
- 5つのタブで数式記号を簡単挿入（基本、演算子、ギリシャ文字、関数、その他）
- MathJaxによるリアルタイムプレビュー機能
- インライン数式とディスプレイ数式の切り替え対応

### v1.2.0 (2025-11-22)

- 外部スクリプト実行のタイムアウト撤廃（無制限実行可能）
- 3つすべての外部スクリプトがツールバーに表示されるように修正
- スクリプトメニューのクロージャ問題を修正
- 長時間実行スクリプトに完全対応

### v1.1.0 (2025-11-22)

- 問題に配点フィールドを追加
- 必答・選択の区別機能
- 解答用紙自動生成機能
- PDF直接出力機能
- 問題並び替え機能
- 画像挿入機能（6種類の配置オプション）
- 外部Pythonスクリプト実行機能（最大3つ登録可能）
- 数式表示の改善（MathJax設定の修正）
- Windows環境の完全サポート

### v1.0.0 (2025-11-22)

- 初回リリース
- 基本的な問題作成・編集機能
- HTML出力機能
- プロンプト生成機能
