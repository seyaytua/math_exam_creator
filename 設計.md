Math Exam Creator - 完全設計書 v1.0
📋 目次
プロジェクト概要
システムアーキテクチャ
ディレクトリ構成
主要コンポーネント詳細
データフロー
ファイル形式
実装済み機能
既知の課題
今後の実装予定
セットアップ手順

1. プロジェクト概要
1.1 目的
数学のテスト問題を効率的に作成・管理・出力するためのデスクトップアプリケーション
1.2 主な機能
問題作成: マークダウンまたはHTML形式での問題編集
リアルタイムプレビュー: 入力内容を即座に確認
プロジェクト管理: 保存・読み込み・編集
印刷用出力: HTML形式でテスト用紙を生成
AI支援: 問題生成用プロンプトの自動作成
表紙作成: 試験情報の入力と管理
1.3 技術スタック

カテゴリ
技術
バージョン
プログラミング言語
Python
3.11+
GUIフレームワーク
PySide6 (Qt6)
6.5+
マークダウン処理
python-markdown
3.4+
数式レンダリング
MathJax (JavaScript)
3.x
データ形式
JSON
-


2. システムアーキテクチャ
2.1 アーキテクチャ図
┌─────────────────────────────────────────────┐
│           Main Window (QMainWindow)          │
│  ┌────────────┐  ┌──────────────────────┐  │
│  │  Menu Bar  │  │     Tool Bar         │  │
│  └────────────┘  └──────────────────────┘  │
│  ┌──────────────────────────────────────┐  │
│  │        Tab Widget (QTabWidget)       │  │
│  │  ┌────────┐ ┌────────┐ ┌────────┐  │  │
│  │  │ 表紙   │ │ 問題1  │ │ 問題2  │  │  │
│  │  │Editor  │ │Editor  │ │Editor  │  │  │
│  │  └────────┘ └────────┘ └────────┘  │  │
│  └──────────────────────────────────────┘  │
│  ┌──────────────────────────────────────┐  │
│  │          Status Bar                   │  │
│  └──────────────────────────────────────┘  │
└─────────────────────────────────────────────┘
         │                    │
         ▼                    ▼
    ┌─────────┐         ┌─────────┐
    │ Project │         │Exporter │
    │  Model  │         │ (HTML)  │
    └─────────┘         └─────────┘

2.2 MVCパターン
Model: src/models/ - データ構造とビジネスロジック
View: src/widgets/, src/dialogs/ - UI表示
Controller: src/main_window.py - イベント処理とデータバインディング

3. ディレクトリ構成
math_exam_creator/
├── main.py                          # エントリーポイント
├── requirements.txt                 # 依存パッケージリスト
├── README.md                        # プロジェクト説明
└── src/
    ├── __init__.py
    ├── config.py                    # 設定管理（JSON）
    ├── styles.py                    # アプリケーション全体のスタイル
    ├── main_window.py               # メインウィンドウ
    │
    ├── models/                      # データモデル
    │   ├── __init__.py
    │   └── project.py              # Project, Problem クラス
    │
    ├── widgets/                     # UIウィジェット
    │   ├── __init__.py
    │   ├── cover_editor.py         # 表紙編集ウィジェット
    │   ├── problem_editor.py       # マークダウン問題エディタ
    │   └── html_editor.py          # HTML問題エディタ
    │
    ├── dialogs/                     # ダイアログ
    │   ├── __init__.py
    │   ├── export_dialog.py        # エクスポート設定ダイアログ
    │   └── prompt_generator_dialog.py  # プロンプト生成ダイアログ
    │
    ├── exporters/                   # 出力機能
    │   ├── __init__.py
    │   └── html_exporter.py        # HTML出力エンジン
    │
    └── utils/                       # ユーティリティ
        ├── __init__.py
        └── markdown_renderer.py    # マークダウン→HTML変換


4. 主要コンポーネント詳細
4.1 データモデル (src/models/project.py)
Project クラス
Copyclass Project:
    """プロジェクト全体を管理"""
    
    # 属性
    - title: str                    # プロジェクト名
    - cover_content: str            # 表紙データ（JSON文字列）
    - problems: List[Problem]       # 問題リスト
    - created_at: str              # 作成日時（ISO8601）
    - updated_at: str              # 更新日時（ISO8601）
    - file_path: Optional[Path]    # ファイルパス
    
    # メソッド
    - add_problem(problem)         # 問題を追加
    - remove_problem(index)        # 問題を削除
    - save(file_path)              # JSONファイルに保存
    - load(file_path)              # JSONファイルから読み込み
    - to_dict()                    # 辞書に変換
    - from_dict(data)              # 辞書から生成

Problem クラス
Copyclass Problem:
    """個別の問題データ"""
    
    # 属性
    - title: str                   # 問題タイトル
    - content: str                 # 問題内容（マークダウンまたはHTML）
    - created_at: str             # 作成日時
    - updated_at: str             # 更新日時
    
    # メソッド
    - to_dict()                   # 辞書に変換
    - from_dict(data)             # 辞書から生成

4.2 UIウィジェット
CoverEditor (src/widgets/cover_editor.py)
目的: 表紙情報の編集
主要UI要素:
試験名入力フィールド
サブタイトル入力
学校名、学年入力
科目、実施日入力
試験時間、配点入力
注意事項テキストエリア
メソッド:
Copy- get_cover_data() -> dict        # 表紙データを取得
- set_cover_data(data: dict)      # 表紙データを設定

ProblemEditor (src/widgets/problem_editor.py)
目的: マークダウン形式での問題編集
レイアウト:
┌─────────────────────────────────────┐
│  ツールバー（書式ボタン）            │
├──────────────┬──────────────────────┤
│  編集エリア  │  プレビューエリア    │
│ (QTextEdit)  │  (QWebEngineView)    │
│              │                      │
│ マークダウン │  レンダリング結果    │
│ 入力         │  + MathJax数式       │
└──────────────┴──────────────────────┘

主要機能:
リアルタイムプレビュー（800ms遅延）
スクロール位置保持
数式挿入ボタン
MathJax自動再処理
メソッド:
Copy- insert_markdown(prefix, suffix)  # マークダウン記法挿入
- get_text() -> str               # テキスト取得
- set_text(text: str)             # テキスト設定
- _do_update_preview()            # プレビュー更新
- _retypeset_mathjax()            # MathJax再処理

HTMLEditor (src/widgets/html_editor.py)
目的: HTML形式での問題編集
ProblemEditorとの違い:
HTMLタグを直接編集
表の挿入が容易
レイアウトの自由度が高い
メソッド:
Copy- insert_html(prefix, suffix)     # HTMLタグ挿入
- insert_table()                  # 表を挿入
- get_text() -> str              # HTML取得
- set_text(text: str)            # HTML設定

4.3 ダイアログ
ExportDialog (src/dialogs/export_dialog.py)
目的: エクスポート設定
設定項目:
Copy{
    'format': 'html' | 'pdf',           # 出力形式
    'page_size': 'A4' | 'B5' | 'Letter', # 用紙サイズ
    'problems_per_page': 1 | 2,         # 1ページあたりの問題数
    'show_cover': bool,                  # 表紙を含める
    'show_problem_numbers': bool,        # 問題番号を表示
    'show_answers': bool,                # 解答を表示（未実装）
    'font_size': int,                    # フォントサイズ (8-20pt)
    'line_spacing': float,               # 行間 (1.5, 1.8, 2.0)
    'margin': str                        # 余白 ('15mm', '20mm', '25mm')
}

PromptGeneratorDialog (src/dialogs/prompt_generator_dialog.py)
目的: AI問題生成用プロンプト作成
入力項目:
単元・トピック
難易度（基礎/標準/応用/発展）
対象学年
問題数
問題形式（計算/証明/グラフ/文章題）
追加要件（自由記述）
出力:
マークダウン形式プロンプト
HTML形式プロンプト（選択可能）
クリップボードコピー機能
4.4 出力エンジン
HTMLExporter (src/exporters/html_exporter.py)
目的: プロジェクトをHTML形式で出力
処理フロー:
1. 表紙HTML生成 (_generate_cover)
   ↓
2. 問題HTML生成 (_generate_problems)
   ↓
3. マークダウン→HTML変換（MarkdownRenderer使用）
   ↓
4. 完全なHTMLドキュメント生成 (_wrap_document)
   ↓
5. ファイルに書き込み

スタイル特徴:
テスト用紙デザイン（黒枠、明朝体）
印刷最適化（@page設定）
MathJaxによる数式レンダリング
レスポンシブ対応
メソッド:
Copy- export(project, output_path, options)  # メイン出力メソッド
- _generate_cover(project, options)      # 表紙生成
- _generate_problems(problems, options)  # 問題生成
- _wrap_document(cover, problems, ...)   # HTML完成

4.5 ユーティリティ
MarkdownRenderer (src/utils/markdown_renderer.py)
目的: マークダウン→HTML変換 + 数式処理
処理手順:
1. 数式保護 (_protect_math)
   - $$...$$ と $...$ を一時的にプレースホルダーに置換
   ↓
2. マークダウン変換 (python-markdown)
   - 見出し、リスト、表などをHTML化
   ↓
3. 数式復元 (_restore_math)
   - プレースホルダーをMathJax形式に戻す
   ↓
4. HTMLラップ (_wrap_html)
   - スタイルとMathJaxスクリプトを追加

メソッド:
Copy- render(text: str) -> str           # メイン変換メソッド
- _protect_math(text) -> tuple       # 数式を保護
- _restore_math(html) -> str         # 数式を復元
- _wrap_html(content) -> str         # HTMLをラップ


5. データフロー
5.1 問題作成フロー
ユーザー入力
    ↓
ProblemEditor / HTMLEditor
    ↓
800ms タイマー
    ↓
MarkdownRenderer / HTMLラッパー
    ↓
QWebEngineView でプレビュー表示
    ↓
MathJax による数式レンダリング

5.2 保存フロー
メニュー「保存」クリック
    ↓
各エディタから get_text()
    ↓
Problem オブジェクトに格納
    ↓
Project.to_dict()
    ↓
JSON形式でファイル書き込み (.mep)

5.3 エクスポートフロー
メニュー「エクスポート」クリック
    ↓
ExportDialog で設定入力
    ↓
表紙データ取得 (CoverEditor)
    ↓
問題データ取得 (各Editor)
    ↓
HTMLExporter.export()
    ↓
HTMLファイル生成
    ↓
ブラウザで開く（オプション）


6. ファイル形式
6.1 プロジェクトファイル (.mep)
形式: JSON
構造:
Copy{
  "version": "1.0",
  "title": "第1回定期考査",
  "cover_content": "{\"exam_title\":\"...\",\"school_name\":\"...\"}",
  "problems": [
    {
      "title": "問題 1",
      "content": "## 問題1\n次の方程式を解け。\n\n$$x^2 + 2x + 1 = 0$$",
      "created_at": "2025-11-22T12:00:00",
      "updated_at": "2025-11-22T12:30:00"
    }
  ],
  "created_at": "2025-11-22T12:00:00",
  "updated_at": "2025-11-22T12:30:00"
}

6.2 設定ファイル
場所: ~/.math_exam_creator/config.json
内容:
Copy{
  "window": {
    "width": 1200,
    "height": 800
  },
  "editor": {
    "font_family": "Courier New",
    "font_size": 12,
    "show_line_numbers": true,
    "word_wrap": true
  },
  "preview": {
    "auto_update": true,
    "update_delay": 500
  }
}


7. 実装済み機能
7.1 完全実装 ✅

機能
説明
ファイル
プロジェクト管理
新規作成、開く、保存、名前を付けて保存
main_window.py
表紙編集
試験情報の入力
cover_editor.py
マークダウンエディタ
リアルタイムプレビュー付き
problem_editor.py
HTMLエディタ
HTML直接編集
html_editor.py
HTML出力
テスト用紙形式で出力
html_exporter.py
プロンプト生成
AI用プロンプト作成
prompt_generator_dialog.py
設定管理
ウィンドウサイズ等の保存
config.py

7.2 部分実装 ⚠️

機能
状態
課題
数式表示
部分的に動作
複雑な数式で表示エラー
スクロール位置保持
基本動作
時々ずれる


8. 既知の課題
8.1 数式表示の問題 🔴
症状:
複数行の数式が正しく表示されない
一部の数式で「Missing or unrecognized delimiter」エラー
MathJaxの初期化タイミングの問題
原因:
LaTeX記法のエスケープ処理が不完全
マークダウン処理と数式処理の競合
QWebEngineViewの動的コンテンツ更新時の再レンダリング問題
暫定対処法:
インライン数式（$...$）を優先使用
複雑な数式はHTMLモードで直接記述
数式前後に空行を入れる
根本的な解決策（今後実装）:
Copy# 数式パーサーの改善
def _protect_math_improved(self, text: str):
    # より厳密な正規表現パターン
    # ネストした括弧の処理
    # エスケープ文字の適切な処理
    pass

8.2 その他の課題

課題
優先度
説明
プレビューのちらつき
中
HTMLを再設定するたびに画面が一瞬白くなる
大きいファイルの処理
低
問題数が多いと動作が重くなる
Undo/Redo
中
エディタの元に戻す機能が未実装


9. 今後の実装予定
9.1 優先度: 高 🔴
数式表示の完全修正
MathJaxの安定化
エラーハンドリングの強化
テストケースの追加
PDF直接出力
Copy# weasyprint または reportlab を使用
from weasyprint import HTML
HTML(string=html_content).write_pdf('output.pdf')

Undo/Redo機能
Copy# QTextEditの標準機能を活用
self.text_editor.undo()
self.text_editor.redo()

9.2 優先度: 中 🟡
ビジュアル数式エディタ
よく使う数式のテンプレート
ドラッグ&ドロップで挿入
プレビュー付き選択ダイアログ
問題テンプレート
Copytemplates = {
    '二次方程式': 'ax^2 + bx + c = 0 の形式',
    '因数分解': '...',
    '確率': '...'
}

問題の並び替え
ドラッグ&ドロップでタブ移動
問題番号の自動更新
9.3 優先度: 低 🟢
画像挿入機能
ファイル選択ダイアログ
Base64エンコードでHTML埋め込み
解答用紙生成
別ページで解答欄を自動生成
配点の自動計算
複数ページ表紙
注意事項の詳細化
カスタムレイアウト
プラグインシステム
外部スクリプトの実行
カスタムエクスポーター

10. セットアップ手順
10.1 環境要件
OS: macOS, Windows, Linux
Python: 3.11以上
メモリ: 最低4GB推奨
10.2 インストール手順
Copy# 1. リポジトリのクローン
git clone <repository-url>
cd math_exam_creator

# 2. 仮想環境の作成（推奨）
python -m venv venv
source venv/bin/activate  # macOS/Linux
# または
venv\Scripts\activate  # Windows

# 3. 依存パッケージのインストール
pip install -r requirements.txt

# 4. アプリケーションの起動
python main.py

10.3 requirements.txt
CopyPySide6>=6.5.0
PySide6-Addons>=6.5.0
markdown>=3.4.0
pymdown-extensions>=10.0.0

10.4 開発環境のセットアップ
Copy# 開発用追加パッケージ
pip install pytest black flake8 mypy

# コードフォーマット
black src/

# 型チェック
mypy src/

# テスト実行
pytest tests/


11. トラブルシューティング
11.1 よくある問題
Q: アプリケーションが起動しない
Copy# Pythonバージョン確認
python --version  # 3.11以上必要

# 依存パッケージの再インストール
pip install --upgrade -r requirements.txt

Q: 数式が表示されない
インターネット接続を確認（MathJaxはCDN経由）
ブラウザのJavaScript設定を確認
数式の記法を確認（$...$ または $$...$$）
Q: プレビューが更新されない
800ms待つ（タイマー遅延）
テキストエディタにフォーカスがあるか確認
アプリケーションを再起動
11.2 ログとデバッグ
Copy# デバッグモードで起動
# main.py に以下を追加
import logging
logging.basicConfig(level=logging.DEBUG)


12. コントリビューション
12.1 開発ガイドライン
コーディング規約: PEP 8に準拠
コメント: 日本語で記述
型ヒント: 可能な限り使用
テスト: 新機能には必ずテストを追加
12.2 ブランチ戦略
main          # 安定版
├── develop   # 開発版
├── feature/* # 新機能開発
└── bugfix/*  # バグ修正


13. ライセンス
MIT License

14. 連絡先・サポート
開発者: [Your Name]
メール: [your-email@example.com]
Issue Tracker: [GitHub Issues URL]

15. 変更履歴
v1.0.0 (2025-11-22)
初回リリース
基本的な問題作成・編集機能
HTML出力機能
プロンプト生成機能

この設計書は引き継ぎ用に作成されました。
不明点があれば、各ファイルのdocstringとコメントを参照してください。